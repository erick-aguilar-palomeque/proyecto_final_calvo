CREATE TABLE Pacientes(
	folio_p serial PRIMARY KEY,
	nom_p text,
	edad_p int,
	sexo_p text check(sexo_p ~* '(femenino|masculino)'),
	fecha_registro date default now(),
	correo text UNIQUE,
	estado_p boolean default true	
);

CREATE TABLE Laboratoristas(
	cedula_lab text PRIMARY KEY,
	nom_lab text,
	fecha_nac_lab date,
	sexo_lab text,
	correo text UNIQUE,
	fecha_contratacion date default now(),	
	estado_lab boolean default true
);


CREATE TABLE Analisis(
	num_a serial PRIMARY KEY,
	nom_a text,
	tiempo_realizacion int,
	estado_a boolean default true
);

CREATE TABLE Historial_clinico(
	folio_a serial PRIMARY KEY,
	folio_p int REFERENCES Pacientes(folio_p),
	num_a int REFERENCES Analisis(num_a),
	status int default 1,
	fecha date default now(),
	cedula_lab text REFERENCES Laboratoristas(cedula_lab)	 
);


CREATE TABLE Materiales(
	codi_barra_m serial PRIMARY KEY,
	nom_m text,
	stock_max_m int,
	stock_min_m int,
	stock_actual_m int,
	estado_m boolean default true
);

CREATE TABLE Atributos(
	num_atri serial PRIMARY KEY,
	nom_atri text,
	descrip_atri text,
	min float,
	max float,
	estado_atri boolean default true
);

CREATE TABLE Unidad_medida(
	num_unidad serial PRIMARY KEY,
	nom_unidad text
);

CREATE TABLE Reactivos(
	codi_barra_r serial PRIMARY KEY,
	nom_r text,
	num_unidad int REFERENCES Unidad_medida(num_unidad),
	stock_max_r float,
	stock_min_r float,
	stock_actual_r float,
	estado_r boolean default true
);

CREATE TABLE Inventario_materiales(
	num_inv_m serial PRIMARY KEY,	
	fecha_inv_m date default now(),
	codi_barra_m int REFERENCES Materiales(codi_barra_m),
	stock_anterior_m int,
	stock_despues_m int,
	cant_ocupada_m int,
	folio_a int REFERENCES Historial_clinico(
	folio_a)
);

CREATE TABLE Inventario_reactivos(
	num_inv_r serial PRIMARY KEY,	
	fecha_inv_r date default now(),
	codi_barra_r int REFERENCES Reactivos(codi_barra_r),
	stock_anterior_r float,
	cant_ocupada_r float,
	stock_despues_r float,
	folio_a int REFERENCES Historial_clinico(folio_a)
);

CREATE TABLE Det_a_materiales(
	num_a int REFERENCES Analisis(num_a),
	cons_det_a_materiales int,
	codi_barra_m int REFERENCES Materiales(codi_barra_m),
	PRIMARY KEY(num_a,cons_det_a_materiales),
	cant_ocupada_m int
);

CREATE TABLE Det_a_atributos(
	num_a int REFERENCES Analisis(num_a),
	cons_det_a_atributos int,
	num_atri int REFERENCES Atributos(num_atri),
	PRIMARY KEY(num_a, cons_det_a_atributos)
);

CREATE TABLE Det_atributos(
	num_atri int REFERENCES Atributos(num_atri),
	cons_det_atributos int,
	codi_barra_r int REFERENCES Reactivos(codi_barra_r),
	PRIMARY KEY(num_atri, cons_det_atributos),
	cant_ocupada_r float
);

CREATE TABLE Resultados(
	folio_a int REFERENCES Historial_clinico(folio_a),
	cons_resultados int,
	resultado float,
	num_a int,
	cons_det_a_atributos int,
	FOREIGN KEY(num_a, cons_det_a_atributos) REFERENCES 
	Det_a_atributos(num_a, cons_det_a_atributos),
	num_atri int REFERENCES Atributos(num_atri),
	PRIMARY KEY(folio_a, cons_resultados)	
);

insert into unidad_medida(nom_unidad) values('Kg');
insert into unidad_medida(nom_unidad) values('Gr');
insert into unidad_medida(nom_unidad) values('Lt');
insert into unidad_medida(nom_unidad) values('Ml');


insert into pacientes (nom_p, edad_p, sexo_p, correo) values ('Daniel Anaya', 21, 'MASCULINO', 'daniel@hotmal.com');
insert into pacientes (nom_p, edad_p, sexo_p, correo) values ('Erick Aguilar', 20, 'MASCULINO', 'erick@hotmal.com');
insert into pacientes (nom_p, edad_p, sexo_p, correo) values ('Xiomara Castañeda', 20, 'FEMENINO', 'xiomara@hotmal.com');

insert into laboratoristas (cedula_lab,nom_lab, sexo_lab, correo,fecha_nac_lab) values(UPPER('ABC1'),UPPER('luis'),UPPER('masculino'), UPPER('luis@gmail.com'),'07/12/2000');
insert into laboratoristas (cedula_lab,nom_lab, sexo_lab, correo,fecha_nac_lab) values(UPPER('ABC2'),UPPER('mario'),UPPER('masculino'), UPPER('mario@gmail.com'),'07/12/2000');
insert into laboratoristas (cedula_lab,nom_lab, sexo_lab, correo,fecha_nac_lab) values(UPPER('ABC3'),UPPER('marleny'),UPPER('femenino'), UPPER('marleny@gmail.com'),'07/12/2000');

insert into analisis(nom_a, tiempo_realizacion) values ('CANCER',1);
insert into analisis(nom_a, tiempo_realizacion) values ('AZUCAR',2);
insert into analisis(nom_a, tiempo_realizacion) values ('CORONAVIRUS',3);
insert into analisis(nom_a, tiempo_realizacion) values ('SIDA',4);

insert into historial_clinico (folio_p, cedula_lab, num_a, fecha, status) values (9,'ABC1', 38, now(), 1);
insert into historial_clinico (folio_p, cedula_lab, num_a, fecha, status) values (10,'ABC2', 39, now(), 2);
insert into historial_clinico (folio_p, cedula_lab, num_a, fecha, status) values (11,'ABC3', 40, now(), 3);
insert into historial_clinico (folio_p, cedula_lab, num_a, fecha, status) values (9,'ABC3', 1, now(), 3);



--DROP TABLES
drop table resultados;
drop table Det_atributos;
drop table Det_a_atributos;
drop table Det_a_materiales;
drop table Inventario_reactivos;
drop table Inventario_materiales;
drop table Reactivos;
drop table unidad_medida;
drop table atributos;
drop table Materiales;
drop table historial_clinico;
drop table analisis;
drop table laboratoristas;
drop table pacientes;